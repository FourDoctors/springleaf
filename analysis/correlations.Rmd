```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE)
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(include=TRUE)
knitr::opts_chunk$set(results="asis")
knitr::opts_chunk$set(fig.width=12)
knitr::opts_chunk$set(fig.height=14)
prjpath <- "~/work/learn/competitions/kaggle/springleaf/"
datapath <- paste(prjpath, "data/", sep="")
analpath <- paste(prjpath, "analyses/", sep="")
rcodepath <- paste(analpath, "Rcode/", sep="")
setwd(analpath)
```
```{r loadLibsAndSource, include=FALSE}
reqdpkgs <- c("lattice", "latticeExtra", "ggplot2", "reshape2",
              "ggmap",	"plyr", "corrplot", "lubridate",
              "Hmisc", "corrplot", "rgdal", "sp")
lapply(reqdpkgs, library, character.only=TRUE)
```

#Introduction

We study the correlations between the variables, using the error-code
fixed data. The values representing error codes in the numerical
variables of the data are 1 to 2 orders of magnitude larger than the
normal values in that variable. This makes sense if these large (or
sometimes negative) values are to represent errors. However, their
large values will skew any numerical study that does not notice them
as error-codes. We have identified the error-codes and replaced them
with NAs. In this analysis of the correlations we will use the
error-code fixed data.


```{r dataload}
train <- read.csv(paste(datapath, 'train_ecfixed.csv', sep=""),
                  stringsAsFactor=FALSE)
test <- read.csv(paste(datapath, 'test_ecfixed.csv', sep=""),
                 stringsAsFactor=FALSE)
```

```{r datatypes}
V <- ncol(train)
predictors <- names(train)[-V]
predictor_types <- sapply(predictors, function(p) class(train[, p]))
print("Data types in the data frame train")
print(table(predictor_types))
```
We will separate the columns by their data-type,

```{r colByDataType}
predictors_chr <- predictors[predictor_types == 'character']
predictors_num <- predictors[predictor_types == 'integer' | predictor_types == 'numeric']
```

We have written a function that computes the entropies of the
variables. We use that function to compute the entropies for the
error-code fixed data. We expect the function to be loaded in this R session.

```{r varentropies}
var.entropies <- predictor.entropies(names(train))
var.entropies$median <- as.numeric(var.entropies$median)
var.entropies$max <- as.numeric(var.entropies$max)
var.entropies$min <- as.numeric(var.entropies$min)
var.entropies$datatype <- predictor_types[var.entropies$variable]

```

**NOTICE** We have labelled the data variables as *date_xxx*, but have
  not labelled them as such above. These variables should be labelled
  as _character_, and we will relabel them as _date_ when
  appropriate. Another thing to remember is that the numeric variables
  are both _integer_ and _numeric_ in _var.entropies$datatype_.

#Highly correlated variables.
We should expect high correlations only between variables that live in
the same phase space, so the highly correlated variabels should assume
the same set of values, and thus the same number of distinct values
As starters, lets consider numerical variables with 3 or 4 distinct
vals. Since correlations are defined only for numerical variables, we
will subset the variables accordingly.

```{r threevalcor}
var.3val.cor <- cor(train[, with(var.entropies,
                                 variable[distinct_vals == 3 &
                                              (datatype == 'integer' |
                                                   datatype == 'numeric')

                                          ]
                                 )
                          ],
                    use='pairwise.complete.obs'
                    )
var.3val.cor[is.na(var.3val.cor)] <- 0
corrplot(var.3val.cor, method='color', tl.cex=0.5)
```

```{r threevalcor}
var.4val.cor <- cor(train[, with(var.entropies,
                                 variable[distinct_vals == 4 &
                                              (datatype == 'integer' |
                                                   datatype == 'numeric')

                                          ]
                                 )
                          ],
                    use='pairwise.complete.obs'
                    )
var.4val.cor[is.na(var.4val.cor)] <- 0
corrplot(var.4val.cor, method='color', tl.cex=0.5)
```
